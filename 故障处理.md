## 故障定义

故障（Failure）是指服务或设备在运行过程中，因为某种原因导致丧失规定功能或产生安全危害的现象。原因可能是由于硬件异常，操作系统异常，代码缺陷等。

## 故障等级 {#id-故障处理流程-3.1故障等级划分}

根据故障对业务的影响，通常会涉及到：

1）存储集群全局故障，IO无法访问，这将导致这个云平台无法正常工作；或者网络全局故障，导致整个云平台虚拟机陷入瘫痪状态。这类故障通常为最严重的故障，而这类故障通常情况下不会，也不允许发生。

2）虚拟机由于平台及代码缺陷，异常停机；或者面板功能失效，无法创建，删除虚机，云硬盘，网络等。这类故障通常成为局部性故障，虽然影响到了客户业务，但是该影响仅在一台虚机，一个子网，或者某个组件API失效，这些都将不会对故障范围外的其他业务与组件造成影响。除此之外，还有一类故障需要严肃对待，就是可能即将引发全局故障的故障，例如出现一个 Ceph Monitor Down 的情况，这个时候如果在出现一个 Ceph Monitor Down 的情况，将可能引发全局故障；或者一个网络节点异常，这个时候，如果再有一个网络节点异常，很可能就会导致大面积虚机网络不通，造成全局性网络故障。

3）由于平台环境中的各个组件，通常都有高可用设计，而这时候局部组件的损坏不会导致业务不可用。比如 OpenStack API 服务故障，如果相同的 API 服务故障，那么该组件就将无法正常提供服务；或者存储集群中的某个 OSD 故障，当再损坏一个 OSD 后，可能即将引发全局故障；再比如虚拟机 fd 数量达到限制数量的 90%，预计在将来某一时刻，引发虚拟机故障，导致虚拟机不可用。上面描述的故障，在一定条件下，都将可能上升为 P2 等级故障。

4）Ceph Health Warn 报告集群被设置为 noout，nobackfill，当前情况下并不产生故障，但可能在将来一段时间内，更快的引发P1，P2 类的故障。

故障其实可以分更多的等级，为了使等级划分清晰明了，并且具有可执行性。根据上述分析，基本可以将故障分为如下四个等级：

| 故障等级 | 描述 |
| :--- | :--- |
| P1 —— Highest | 全局故障，业务大面积中断 —— 一般只发生在存储或网络中断时 |
| P2 —— High | 局部业务故障，或可能即将引发全局故障 |
| P3 —— Medium | 局部组件故障，或即将引发局部业务故障 |
| P4 —— Low | 警告，可能一定程度上影响稳定运行与性能，或可能引发局部组件故障 |

## 故障分类 {#id-故障处理流程-3.1故障等级划分}

| OpenStack | Ceph | 硬件 | 其他 |
| :--- | :--- | :--- | :--- |
| Nova | MON | CPU | 文件系统 |
| Cinder | OSD | 内存 | 网络路由 |
| Glance | MDS | 网卡 | .... |
| Neutron |  | 磁盘 | 等 |
| Keystone |  | 阵列卡 |  |
| Ceilometer |  | 交换机 |  |

## 故障来源

故障来源通常有两种途径：

* LMA 系统
  * Zabbix  监控告警（短信告警，邮件告警）
  * Grafana 可视化监控
  * ELK 日志分析系统
* 客户直接反馈

理论上讲，只要 LMA 系统足够完善，那么 LMA 收到告警通常在客户反馈之前，也就是说客户的故障反馈通常能够在相关告警中找到关联告警。如果客户反馈的故障无法关联到任何告警，那么我们就应该思考一下，是否存在相关的监控告警缺失。

故障关联，故障分类，故障分级应由高级运维人员负责，并且将对应故障分发至运维人员分析与处理。运维人员完成处理后，需要申请高级运维人员 review 与 verify 处理结果，通过后结束后，完成故障处理报告。

## 故障处理流程

如果运维任务被定性为故障，则故障处理通常涉及下列四个过程，只有当四个过程全部走完后，本次故障处理才可以在 Jira 上面申请 review 并结束流程。

### 故障受理

运维人员收到客户故障反馈，或者 LMA 短信，邮件告警后，开始介入故障受理，10min内完成故障等级评估，并以短信、邮件、电话等方式反馈给客户故障等级和预计恢复时间信息；

### 故障处理

运维人员根据故障现象，按照对应的故障预案修复问题，故障处理流程按照内部故障处理流程执行；

### 故障报告

故障消除后，对于P3，P4级别故障，需有对应的 Jira 任务，由高级人员 review 后结束该任务。对于 P1，P2级别故障，除需有对应的 Jira 任务外，还需在72小时内发出故障报告，并针对故障，提出故障改善方案，并且通知所有相关人员。

补充:

1. 故障响应和故障计时开始时间，以客户电话或邮件反馈时间为准;

2. 在故障受理解决时间内，除事故处理进度邮件或短信反馈外，事故处理人员不接受任何客户问题咨询；

3.在故障处理时,如果无法快速解决，会进行故障处理升级，寻求更多资源介入处理，具体各方的工作方式:

a\)一线

运维:

响应故障,并初步排除故障,执行预案

b\)二线

devops:

协助排查处理,定位故障范围

c\)三线

研发支持:

进行故障排查,代码分析, 制定临时恢复预案

4.针对故障报告改进,

每周

定期进行故障问题改进回顾和跟进，直至问题彻底解决

1. 具体服务的故障预案规范请参见:

[故障预案规范](https://confluence.ustack.com/pages/viewpage.action?pageId=7373987)

1. 针对服务的故障报告规范请参见:

[5\_故障报告规范](https://confluence.ustack.com/pages/viewpage.action?pageId=7373991)

7.针对整个处理流程如下图:

